{"version":3,"file":"food-booking.service.js","sources":["services/food-booking.service.js"],"sourcesContent":["/**\r\n * FoodBookingService - 美食制作体验预约服务\r\n * 负责美食制作体验预约业务逻辑处理\r\n */\r\n\r\nimport StorageService from './storage.service.js'\r\n\r\n/**\r\n * 生成唯一ID\r\n * @returns {string}\r\n */\r\nfunction generateId() {\r\n  return Date.now().toString(36) + Math.random().toString(36).substr(2, 9)\r\n}\r\n\r\n/**\r\n * 示例美食制作体验活动数据\r\n */\r\nconst SAMPLE_COOKING_EXPERIENCES = [\r\n  {\r\n    id: 'exp-1',\r\n    title: '五色糯米饭制作体验',\r\n    description: '学习壮族传统五色糯米饭的制作工艺，了解天然植物染色技艺',\r\n    dishName: '五色糯米饭',\r\n    difficulty: '中等',\r\n    date: '2026-02-15',\r\n    time: '09:00',\r\n    location: '南宁市青秀区民族大道88号壮乡美食馆',\r\n    availableSlots: 20,\r\n    image: '/static/food/wuse-nuomifan.jpg'\r\n  },\r\n  {\r\n    id: 'exp-2',\r\n    title: '壮族粽子包制体验',\r\n    description: '亲手包制壮族特色粽子，体验传统节日美食文化',\r\n    dishName: '壮族粽子',\r\n    difficulty: '简单',\r\n    date: '2026-02-22',\r\n    time: '14:00',\r\n    location: '南宁市西乡塘区大学路100号美食体验中心',\r\n    availableSlots: 25,\r\n    image: '/static/food/zongzi.jpg'\r\n  },\r\n  {\r\n    id: 'exp-3',\r\n    title: '酸嘢腌制工坊',\r\n    description: '学习壮族传统酸嘢腌制方法，制作属于自己的酸嘢',\r\n    dishName: '酸嘢',\r\n    difficulty: '简单',\r\n    date: '2026-03-01',\r\n    time: '10:00',\r\n    location: '南宁市江南区星光大道66号传统工坊',\r\n    availableSlots: 15,\r\n    image: '/static/food/suanye.jpg'\r\n  },\r\n  {\r\n    id: 'exp-4',\r\n    title: '糍粑制作体验',\r\n    description: '体验传统糍粑制作过程，感受壮族美食文化魅力',\r\n    dishName: '糍粑',\r\n    difficulty: '中等',\r\n    date: '2026-03-15',\r\n    time: '15:00',\r\n    location: '广西民族博物馆美食体验区',\r\n    availableSlots: 18,\r\n    image: '/static/food/ciba.jpg'\r\n  }\r\n]\r\n\r\n\r\n/**\r\n * 获取美食制作体验活动列表\r\n * @returns {Promise<Array>}\r\n */\r\nexport async function getCookingExperiences() {\r\n  // 返回示例数据，实际项目中可从API获取\r\n  return SAMPLE_COOKING_EXPERIENCES\r\n}\r\n\r\n/**\r\n * 创建美食制作体验预约\r\n * @param {string} experienceId - 活动ID\r\n * @param {Object} experience - 活动信息\r\n * @param {Object} formData - 表单数据\r\n * @returns {Promise<Object>} BookingResult\r\n */\r\nexport async function createFoodBooking(experienceId, experience, formData) {\r\n  try {\r\n    const now = new Date().toISOString()\r\n    \r\n    const booking = {\r\n      id: generateId(),\r\n      experienceId: experienceId,\r\n      experienceTitle: experience.title,\r\n      experienceDate: experience.date,\r\n      experienceTime: experience.time,\r\n      experienceLocation: experience.location,\r\n      formData: {\r\n        name: formData.name,\r\n        phone: formData.phone,\r\n        participants: formData.participants || 1,\r\n        remark: formData.remark || ''\r\n      },\r\n      status: 'pending',\r\n      createdAt: now,\r\n      updatedAt: now\r\n    }\r\n    \r\n    await StorageService.saveFoodBooking(booking)\r\n    \r\n    return {\r\n      success: true,\r\n      bookingId: booking.id,\r\n      message: '预约成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to create food booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '预约失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * 取消美食制作体验预约\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object>} CancelResult\r\n */\r\nexport async function cancelFoodBooking(bookingId) {\r\n  try {\r\n    const booking = await StorageService.getFoodBookingById(bookingId)\r\n    \r\n    if (!booking) {\r\n      return {\r\n        success: false,\r\n        message: '预约记录不存在'\r\n      }\r\n    }\r\n    \r\n    if (!canCancelFoodBooking(booking)) {\r\n      return {\r\n        success: false,\r\n        message: '距离活动开始不足24小时，无法取消'\r\n      }\r\n    }\r\n    \r\n    await StorageService.updateFoodBooking(bookingId, {\r\n      status: 'cancelled'\r\n    })\r\n    \r\n    return {\r\n      success: true,\r\n      message: '取消成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to cancel food booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '取消失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 检查是否可取消（24小时规则）\r\n * @param {Object} booking - 预约记录\r\n * @returns {boolean}\r\n */\r\nexport function canCancelFoodBooking(booking) {\r\n  if (!booking) return false\r\n  \r\n  // 只有待确认和已确认状态可以取消\r\n  if (booking.status !== 'pending' && booking.status !== 'confirmed') {\r\n    return false\r\n  }\r\n  \r\n  // 检查24小时规则\r\n  const experienceDateTime = new Date(`${booking.experienceDate}T${booking.experienceTime}`)\r\n  const now = new Date()\r\n  const hoursUntilExperience = (experienceDateTime - now) / (1000 * 60 * 60)\r\n  \r\n  return hoursUntilExperience >= 24\r\n}\r\n\r\n/**\r\n * 获取用户美食制作体验预约列表（按日期排序）\r\n * @returns {Promise<Array>}\r\n */\r\nexport async function getUserFoodBookings() {\r\n  try {\r\n    const bookings = await StorageService.getFoodBookings()\r\n    \r\n    // 按活动日期升序排序\r\n    return bookings.sort((a, b) => {\r\n      const dateA = new Date(`${a.experienceDate}T${a.experienceTime}`)\r\n      const dateB = new Date(`${b.experienceDate}T${b.experienceTime}`)\r\n      return dateA - dateB\r\n    })\r\n  } catch (error) {\r\n    console.error('Failed to get user food bookings:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * 获取单个美食制作体验预约详情\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object|null>}\r\n */\r\nexport async function getFoodBookingDetail(bookingId) {\r\n  return StorageService.getFoodBookingById(bookingId)\r\n}\r\n\r\n/**\r\n * 验证美食制作体验预约表单数据\r\n * @param {Object} formData - 表单数据\r\n * @returns {Object} ValidationResult\r\n */\r\nexport function validateFoodBookingForm(formData) {\r\n  const errors = []\r\n  \r\n  if (!formData.name || !formData.name.trim()) {\r\n    errors.push({ field: 'name', message: '请输入姓名' })\r\n  }\r\n  \r\n  if (!formData.phone || !formData.phone.trim()) {\r\n    errors.push({ field: 'phone', message: '请输入手机号' })\r\n  } else if (!/^1[3-9]\\d{9}$/.test(formData.phone)) {\r\n    errors.push({ field: 'phone', message: '请输入正确的手机号码' })\r\n  }\r\n  \r\n  return {\r\n    valid: errors.length === 0,\r\n    errors: errors\r\n  }\r\n}\r\n\r\nexport default {\r\n  getCookingExperiences,\r\n  createFoodBooking,\r\n  cancelFoodBooking,\r\n  canCancelFoodBooking,\r\n  getUserFoodBookings,\r\n  getFoodBookingDetail,\r\n  validateFoodBookingForm\r\n}\r\n"],"names":["StorageService","uni"],"mappings":"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"}