{"version":3,"file":"booking.service.js","sources":["services/booking.service.js"],"sourcesContent":["/**\r\n * BookingService - 预约服务\r\n * 负责预约业务逻辑处理\r\n */\r\n\r\nimport StorageService from './storage.service.js'\r\n\r\n/**\r\n * 生成唯一ID\r\n * @returns {string}\r\n */\r\nfunction generateId() {\r\n  return Date.now().toString(36) + Math.random().toString(36).substr(2, 9)\r\n}\r\n\r\n/**\r\n * 创建预约\r\n * @param {string} eventId - 活动ID\r\n * @param {Object} event - 活动信息\r\n * @param {Object} formData - 表单数据\r\n * @returns {Promise<Object>} BookingResult\r\n */\r\nexport async function createBooking(eventId, event, formData) {\r\n  try {\r\n    const now = new Date().toISOString()\r\n    \r\n    const booking = {\r\n      id: generateId(),\r\n      eventId: eventId,\r\n      eventTitle: event.title,\r\n      eventDate: event.date,\r\n      eventTime: event.time,\r\n      eventLocation: event.location,\r\n      formData: {\r\n        name: formData.name,\r\n        phone: formData.phone,\r\n        participants: formData.participants || 1,\r\n        remark: formData.remark || ''\r\n      },\r\n      status: 'pending',\r\n      createdAt: now,\r\n      updatedAt: now\r\n    }\r\n    \r\n    await StorageService.saveBooking(booking)\r\n    \r\n    return {\r\n      success: true,\r\n      bookingId: booking.id,\r\n      message: '预约成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to create booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '预约失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 取消预约\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object>} CancelResult\r\n */\r\nexport async function cancelBooking(bookingId) {\r\n  try {\r\n    const booking = await StorageService.getBookingById(bookingId)\r\n    \r\n    if (!booking) {\r\n      return {\r\n        success: false,\r\n        message: '预约记录不存在'\r\n      }\r\n    }\r\n    \r\n    if (!canCancel(booking)) {\r\n      return {\r\n        success: false,\r\n        message: '距离活动开始不足24小时，无法取消'\r\n      }\r\n    }\r\n    \r\n    await StorageService.updateBooking(bookingId, {\r\n      status: 'cancelled'\r\n    })\r\n    \r\n    return {\r\n      success: true,\r\n      message: '取消成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to cancel booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '取消失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 检查是否可取消（24小时规则）\r\n * @param {Object} booking - 预约记录\r\n * @returns {boolean}\r\n */\r\nexport function canCancel(booking) {\r\n  if (!booking) return false\r\n  \r\n  // 只有待确认和已确认状态可以取消\r\n  if (booking.status !== 'pending' && booking.status !== 'confirmed') {\r\n    return false\r\n  }\r\n  \r\n  // 检查24小时规则\r\n  const eventDateTime = new Date(`${booking.eventDate}T${booking.eventTime}`)\r\n  const now = new Date()\r\n  const hoursUntilEvent = (eventDateTime - now) / (1000 * 60 * 60)\r\n  \r\n  return hoursUntilEvent >= 24\r\n}\r\n\r\n/**\r\n * 获取用户预约列表（按日期排序）\r\n * @returns {Promise<Array>}\r\n */\r\nexport async function getUserBookings() {\r\n  try {\r\n    const bookings = await StorageService.getBookings()\r\n    \r\n    // 按活动日期升序排序\r\n    return bookings.sort((a, b) => {\r\n      const dateA = new Date(`${a.eventDate}T${a.eventTime}`)\r\n      const dateB = new Date(`${b.eventDate}T${b.eventTime}`)\r\n      return dateA - dateB\r\n    })\r\n  } catch (error) {\r\n    console.error('Failed to get user bookings:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * 获取单个预约详情\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object|null>}\r\n */\r\nexport async function getBookingDetail(bookingId) {\r\n  return StorageService.getBookingById(bookingId)\r\n}\r\n\r\n/**\r\n * 验证表单数据\r\n * @param {Object} formData - 表单数据\r\n * @returns {Object} ValidationResult\r\n */\r\nexport function validateForm(formData) {\r\n  const errors = []\r\n  \r\n  if (!formData.name || !formData.name.trim()) {\r\n    errors.push({ field: 'name', message: '请输入姓名' })\r\n  }\r\n  \r\n  if (!formData.phone || !formData.phone.trim()) {\r\n    errors.push({ field: 'phone', message: '请输入手机号' })\r\n  } else if (!/^1[3-9]\\d{9}$/.test(formData.phone)) {\r\n    errors.push({ field: 'phone', message: '请输入正确的手机号码' })\r\n  }\r\n  \r\n  return {\r\n    valid: errors.length === 0,\r\n    errors: errors\r\n  }\r\n}\r\n\r\nexport default {\r\n  createBooking,\r\n  cancelBooking,\r\n  canCancel,\r\n  getUserBookings,\r\n  getBookingDetail,\r\n  validateForm\r\n}\r\n"],"names":["StorageService","uni"],"mappings":"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"}