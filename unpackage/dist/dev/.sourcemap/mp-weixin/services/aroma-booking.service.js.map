{"version":3,"file":"aroma-booking.service.js","sources":["services/aroma-booking.service.js"],"sourcesContent":["/**\r\n * AromaBookingService - 香氛沙龙预约服务\r\n * 负责香氛沙龙预约业务逻辑处理\r\n */\r\n\r\nimport StorageService from './storage.service.js'\r\n\r\n/**\r\n * 生成唯一ID\r\n * @returns {string}\r\n */\r\nfunction generateId() {\r\n  return Date.now().toString(36) + Math.random().toString(36).substr(2, 9)\r\n}\r\n\r\n/**\r\n * 示例香氛沙龙活动数据\r\n */\r\nconst SAMPLE_SALONS = [\r\n  {\r\n    id: 'salon-1',\r\n    title: '壮乡草本香氛调配体验',\r\n    description: '学习壮族传统草本香氛调配技艺，亲手制作专属香氛产品',\r\n    theme: '草本调香',\r\n    date: '2026-02-15',\r\n    time: '14:00',\r\n    location: '南宁市青秀区民族大道88号香愈馆',\r\n    availableSlots: 15,\r\n    image: '/static/salons/herbal.jpg'\r\n  },\r\n  {\r\n    id: 'salon-2',\r\n    title: '精油芳疗放松沙龙',\r\n    description: '体验壮族特色精油芳疗，学习精油使用方法与功效',\r\n    theme: '精油芳疗',\r\n    date: '2026-02-22',\r\n    time: '10:00',\r\n    location: '南宁市西乡塘区大学路100号疗愈中心',\r\n    availableSlots: 20,\r\n    image: '/static/salons/essential-oil.jpg'\r\n  },\r\n  {\r\n    id: 'salon-3',\r\n    title: '香薰蜡烛DIY工坊',\r\n    description: '亲手制作壮族特色香薰蜡烛，感受香氛疗愈的魅力',\r\n    theme: '蜡烛制作',\r\n    date: '2026-03-01',\r\n    time: '15:00',\r\n    location: '南宁市江南区星光大道66号创意工坊',\r\n    availableSlots: 12,\r\n    image: '/static/salons/candle.jpg'\r\n  },\r\n  {\r\n    id: 'salon-4',\r\n    title: '壮乡香包香囊制作',\r\n    description: '学习传统香包香囊制作工艺，了解壮族香文化历史',\r\n    theme: '香包制作',\r\n    date: '2026-03-15',\r\n    time: '09:30',\r\n    location: '广西民族博物馆手工体验区',\r\n    availableSlots: 25,\r\n    image: '/static/salons/sachet.jpg'\r\n  }\r\n]\r\n\r\n\r\n/**\r\n * 获取香氛沙龙活动列表\r\n * @returns {Promise<Array>}\r\n */\r\nexport async function getSalons() {\r\n  // 返回示例数据，实际项目中可从API获取\r\n  return SAMPLE_SALONS\r\n}\r\n\r\n/**\r\n * 创建香氛沙龙预约\r\n * @param {string} salonId - 活动ID\r\n * @param {Object} salon - 活动信息\r\n * @param {Object} formData - 表单数据\r\n * @returns {Promise<Object>} BookingResult\r\n */\r\nexport async function createAromaBooking(salonId, salon, formData) {\r\n  try {\r\n    const now = new Date().toISOString()\r\n    \r\n    const booking = {\r\n      id: generateId(),\r\n      salonId: salonId,\r\n      salonTitle: salon.title,\r\n      salonDate: salon.date,\r\n      salonTime: salon.time,\r\n      salonLocation: salon.location,\r\n      formData: {\r\n        name: formData.name,\r\n        phone: formData.phone,\r\n        participants: formData.participants || 1,\r\n        remark: formData.remark || ''\r\n      },\r\n      status: 'pending',\r\n      createdAt: now,\r\n      updatedAt: now\r\n    }\r\n    \r\n    await StorageService.saveAromaBooking(booking)\r\n    \r\n    return {\r\n      success: true,\r\n      bookingId: booking.id,\r\n      message: '预约成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to create aroma booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '预约失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 取消香氛沙龙预约\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object>} CancelResult\r\n */\r\nexport async function cancelAromaBooking(bookingId) {\r\n  try {\r\n    const booking = await StorageService.getAromaBookingById(bookingId)\r\n    \r\n    if (!booking) {\r\n      return {\r\n        success: false,\r\n        message: '预约记录不存在'\r\n      }\r\n    }\r\n    \r\n    if (!canCancelAromaBooking(booking)) {\r\n      return {\r\n        success: false,\r\n        message: '距离活动开始不足24小时，无法取消'\r\n      }\r\n    }\r\n    \r\n    await StorageService.updateAromaBooking(bookingId, {\r\n      status: 'cancelled'\r\n    })\r\n    \r\n    return {\r\n      success: true,\r\n      message: '取消成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to cancel aroma booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '取消失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 检查是否可取消（24小时规则）\r\n * @param {Object} booking - 预约记录\r\n * @returns {boolean}\r\n */\r\nexport function canCancelAromaBooking(booking) {\r\n  if (!booking) return false\r\n  \r\n  // 只有待确认和已确认状态可以取消\r\n  if (booking.status !== 'pending' && booking.status !== 'confirmed') {\r\n    return false\r\n  }\r\n  \r\n  // 检查24小时规则\r\n  const salonDateTime = new Date(`${booking.salonDate}T${booking.salonTime}`)\r\n  const now = new Date()\r\n  const hoursUntilSalon = (salonDateTime - now) / (1000 * 60 * 60)\r\n  \r\n  return hoursUntilSalon >= 24\r\n}\r\n\r\n/**\r\n * 获取用户香氛沙龙预约列表（按日期排序）\r\n * @returns {Promise<Array>}\r\n */\r\nexport async function getUserAromaBookings() {\r\n  try {\r\n    const bookings = await StorageService.getAromaBookings()\r\n    \r\n    // 按活动日期升序排序\r\n    return bookings.sort((a, b) => {\r\n      const dateA = new Date(`${a.salonDate}T${a.salonTime}`)\r\n      const dateB = new Date(`${b.salonDate}T${b.salonTime}`)\r\n      return dateA - dateB\r\n    })\r\n  } catch (error) {\r\n    console.error('Failed to get user aroma bookings:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * 获取单个香氛沙龙预约详情\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object|null>}\r\n */\r\nexport async function getAromaBookingDetail(bookingId) {\r\n  return StorageService.getAromaBookingById(bookingId)\r\n}\r\n\r\n/**\r\n * 验证香氛沙龙预约表单数据\r\n * @param {Object} formData - 表单数据\r\n * @returns {Object} ValidationResult\r\n */\r\nexport function validateAromaBookingForm(formData) {\r\n  const errors = []\r\n  \r\n  if (!formData.name || !formData.name.trim()) {\r\n    errors.push({ field: 'name', message: '请输入姓名' })\r\n  }\r\n  \r\n  if (!formData.phone || !formData.phone.trim()) {\r\n    errors.push({ field: 'phone', message: '请输入手机号' })\r\n  } else if (!/^1[3-9]\\d{9}$/.test(formData.phone)) {\r\n    errors.push({ field: 'phone', message: '请输入正确的手机号码' })\r\n  }\r\n  \r\n  return {\r\n    valid: errors.length === 0,\r\n    errors: errors\r\n  }\r\n}\r\n\r\nexport default {\r\n  getSalons,\r\n  createAromaBooking,\r\n  cancelAromaBooking,\r\n  canCancelAromaBooking,\r\n  getUserAromaBookings,\r\n  getAromaBookingDetail,\r\n  validateAromaBookingForm\r\n}\r\n"],"names":["StorageService","uni"],"mappings":"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"}