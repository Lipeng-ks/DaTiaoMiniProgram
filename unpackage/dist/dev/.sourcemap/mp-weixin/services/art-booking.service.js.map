{"version":3,"file":"art-booking.service.js","sources":["services/art-booking.service.js"],"sourcesContent":["/**\r\n * ArtBookingService - 艺术节预约服务\r\n * 负责艺术节预约业务逻辑处理\r\n */\r\n\r\nimport StorageService from './storage.service.js'\r\n\r\n/**\r\n * 生成唯一ID\r\n * @returns {string}\r\n */\r\nfunction generateId() {\r\n  return Date.now().toString(36) + Math.random().toString(36).substr(2, 9)\r\n}\r\n\r\n/**\r\n * 示例艺术节活动数据\r\n */\r\nconst SAMPLE_FESTIVALS = [\r\n  {\r\n    id: 'festival-1',\r\n    title: '壮族三月三歌圩节',\r\n    description: '体验壮族传统歌圩文化，欣赏山歌对唱，参与民俗活动',\r\n    date: '2026-04-03',\r\n    time: '09:00',\r\n    location: '南宁市青秀山风景区',\r\n    availableSlots: 50,\r\n    image: '/static/festivals/sanyuesan.jpg'\r\n  },\r\n  {\r\n    id: 'festival-2',\r\n    title: '壮锦织造体验工坊',\r\n    description: '学习壮锦织造技艺，亲手制作壮锦作品，感受非遗魅力',\r\n    date: '2026-04-15',\r\n    time: '14:00',\r\n    location: '广西民族博物馆',\r\n    availableSlots: 20,\r\n    image: '/static/festivals/zhuangjin.jpg'\r\n  },\r\n  {\r\n    id: 'festival-3',\r\n    title: '铜鼓文化艺术展',\r\n    description: '观赏壮族铜鼓艺术，了解铜鼓历史文化，体验铜鼓演奏',\r\n    date: '2026-05-01',\r\n    time: '10:00',\r\n    location: '广西壮族自治区博物馆',\r\n    availableSlots: 100,\r\n    image: '/static/festivals/tonggu.jpg'\r\n  },\r\n  {\r\n    id: 'festival-4',\r\n    title: '壮族服饰文化节',\r\n    description: '欣赏壮族传统服饰展示，体验民族服装试穿，学习服饰文化',\r\n    date: '2026-05-20',\r\n    time: '09:30',\r\n    location: '南宁国际会展中心',\r\n    availableSlots: 80,\r\n    image: '/static/festivals/fuzhi.jpg'\r\n  }\r\n]\r\n\r\n/**\r\n * 获取艺术节活动列表\r\n * @returns {Promise<Array>}\r\n */\r\nexport async function getFestivals() {\r\n  // 返回示例数据，实际项目中可从API获取\r\n  return SAMPLE_FESTIVALS\r\n}\r\n\r\n\r\n/**\r\n * 创建艺术节预约\r\n * @param {string} festivalId - 活动ID\r\n * @param {Object} festival - 活动信息\r\n * @param {Object} formData - 表单数据\r\n * @returns {Promise<Object>} BookingResult\r\n */\r\nexport async function createArtBooking(festivalId, festival, formData) {\r\n  try {\r\n    const now = new Date().toISOString()\r\n    \r\n    const booking = {\r\n      id: generateId(),\r\n      festivalId: festivalId,\r\n      festivalTitle: festival.title,\r\n      festivalDate: festival.date,\r\n      festivalTime: festival.time,\r\n      festivalLocation: festival.location,\r\n      formData: {\r\n        name: formData.name,\r\n        phone: formData.phone,\r\n        participants: formData.participants || 1,\r\n        remark: formData.remark || ''\r\n      },\r\n      status: 'pending',\r\n      createdAt: now,\r\n      updatedAt: now\r\n    }\r\n    \r\n    await StorageService.saveArtBooking(booking)\r\n    \r\n    return {\r\n      success: true,\r\n      bookingId: booking.id,\r\n      message: '预约成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to create art booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '预约失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 取消艺术节预约\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object>} CancelResult\r\n */\r\nexport async function cancelArtBooking(bookingId) {\r\n  try {\r\n    const booking = await StorageService.getArtBookingById(bookingId)\r\n    \r\n    if (!booking) {\r\n      return {\r\n        success: false,\r\n        message: '预约记录不存在'\r\n      }\r\n    }\r\n    \r\n    if (!canCancelArtBooking(booking)) {\r\n      return {\r\n        success: false,\r\n        message: '距离活动开始不足24小时，无法取消'\r\n      }\r\n    }\r\n    \r\n    await StorageService.updateArtBooking(bookingId, {\r\n      status: 'cancelled'\r\n    })\r\n    \r\n    return {\r\n      success: true,\r\n      message: '取消成功'\r\n    }\r\n  } catch (error) {\r\n    console.error('Failed to cancel art booking:', error)\r\n    return {\r\n      success: false,\r\n      message: '取消失败，请重试'\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 检查是否可取消（24小时规则）\r\n * @param {Object} booking - 预约记录\r\n * @returns {boolean}\r\n */\r\nexport function canCancelArtBooking(booking) {\r\n  if (!booking) return false\r\n  \r\n  // 只有待确认和已确认状态可以取消\r\n  if (booking.status !== 'pending' && booking.status !== 'confirmed') {\r\n    return false\r\n  }\r\n  \r\n  // 检查24小时规则\r\n  const festivalDateTime = new Date(`${booking.festivalDate}T${booking.festivalTime}`)\r\n  const now = new Date()\r\n  const hoursUntilFestival = (festivalDateTime - now) / (1000 * 60 * 60)\r\n  \r\n  return hoursUntilFestival >= 24\r\n}\r\n\r\n/**\r\n * 获取用户艺术节预约列表（按日期排序）\r\n * @returns {Promise<Array>}\r\n */\r\nexport async function getUserArtBookings() {\r\n  try {\r\n    const bookings = await StorageService.getArtBookings()\r\n    \r\n    // 按活动日期升序排序\r\n    return bookings.sort((a, b) => {\r\n      const dateA = new Date(`${a.festivalDate}T${a.festivalTime}`)\r\n      const dateB = new Date(`${b.festivalDate}T${b.festivalTime}`)\r\n      return dateA - dateB\r\n    })\r\n  } catch (error) {\r\n    console.error('Failed to get user art bookings:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * 获取单个艺术节预约详情\r\n * @param {string} bookingId - 预约ID\r\n * @returns {Promise<Object|null>}\r\n */\r\nexport async function getArtBookingDetail(bookingId) {\r\n  return StorageService.getArtBookingById(bookingId)\r\n}\r\n\r\n/**\r\n * 验证艺术节预约表单数据\r\n * @param {Object} formData - 表单数据\r\n * @returns {Object} ValidationResult\r\n */\r\nexport function validateArtBookingForm(formData) {\r\n  const errors = []\r\n  \r\n  if (!formData.name || !formData.name.trim()) {\r\n    errors.push({ field: 'name', message: '请输入姓名' })\r\n  }\r\n  \r\n  if (!formData.phone || !formData.phone.trim()) {\r\n    errors.push({ field: 'phone', message: '请输入手机号' })\r\n  } else if (!/^1[3-9]\\d{9}$/.test(formData.phone)) {\r\n    errors.push({ field: 'phone', message: '请输入正确的手机号码' })\r\n  }\r\n  \r\n  return {\r\n    valid: errors.length === 0,\r\n    errors: errors\r\n  }\r\n}\r\n\r\nexport default {\r\n  getFestivals,\r\n  createArtBooking,\r\n  cancelArtBooking,\r\n  canCancelArtBooking,\r\n  getUserArtBookings,\r\n  getArtBookingDetail,\r\n  validateArtBookingForm\r\n}\r\n"],"names":["StorageService","uni"],"mappings":"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"}